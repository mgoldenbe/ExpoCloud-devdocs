<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>ExpoCloud.src.instance API documentation</title>
<meta name="description" content="" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>ExpoCloud.src.instance</code></h1>
</header>
<section id="section-intro">
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python"># @ Meir Goldenberg The module is part of the ExpoCloud Framework

import time
import os
import sys

from src.util import myprint
from src.constants import Verbosity

from src import util
from src.util import InstanceRole, handle_exception
from src.constants import Constants

def is_primary(instance):
    return instance.role == InstanceRole.PRIMARY_SERVER

def is_backup(instance):
    return instance.role == InstanceRole.BACKUP_SERVER

def is_client(instance):
    return instance.role == InstanceRole.CLIENT

class Instance():
    def __init__(self, role, engine):
        &#34;&#34;&#34;
        Objects of this class represent instances.
        `role` - either InstanceRole.CLIENT or InstanceRole.BACKUP_SERVER.
        `engine` - an instance of either AbstractEngine&#39;s subclass or LocalEngine.
        &#34;&#34;&#34;
        self.role = role
        self.engine = engine
        self.active_timestamp = None # last health update, None until handshake
        self.name = None
        if engine:
            self.name = engine.next_instance_name(role)
        self.ip = None
    
    def create(self):
        &#34;&#34;&#34;
        Create the instance
        &#34;&#34;&#34;
        self.ip = self.engine.create_instance(self.name, self.role)
        if self.ip: self.creation_timestamp = time.time()

    def run(self, server_port, max_cpus = None):
        self.engine.run_instance(self.name, self.ip, self.role, server_port, max_cpus)
    
    def __del__(self):
        if self.ip and self.engine:
            if not self.engine.is_local(): # for local, just let it complete
                self.engine.kill_instance(self.name)
    
    def is_healthy(self, tasks_remain: bool):
        &#34;&#34;&#34;
        `task remain` - a Boolean indicating whether there are still tasks remaining.
        Returns true if the instance is healthy, i.e. either:
        - The instance has no IP address (so that no real instance had been created) and there are task remaining.
        - The instance has an IP address, but is not active (i.e. has not shaken hands with the primary server). For client instance, we also require that there still be tasks remaining as indicated. For all types of instances, INSTANCE_MAX_NON_ACTIVE_TIME has not passed since its creation.
        - It is active and HEALTH_UPDATE_LIMIT has not passed since last health 
          update.
        &#34;&#34;&#34;
        if self.active_timestamp:
            result = \
                time.time() - self.active_timestamp &lt;= \
                Constants.HEALTH_UPDATE_LIMIT
            if not result: 
                myprint(Verbosity.all, 
                        f&#34;{self.name} failed to send health updates for too long.   Last update: {util.short_timestamp(self.active_timestamp)}&#34;)
            return result
        
        assert(not self.active_timestamp)

        if self.ip and \
           time.time() - self.creation_timestamp &gt; \
           Constants.INSTANCE_MAX_NON_ACTIVE_TIME:
            myprint(Verbosity.all, f&#34;{self.name} failed to shake hands for too long.   Creation: {util.short_timestamp(self.creation_timestamp)}&#34;) 
            return False
        
        if is_backup(self): return True
        if is_client(self):
            result = tasks_remain
            if not result:
                myprint(Verbosity.all, f&#34;{self.name} is unneeded&#34;)
            return result

        assert(False)

    def shake_hands(self):
        myprint(Verbosity.all, f&#34;{self.name} shook hands&#34;)
        self.active_timestamp = time.time()

class ClientInstance(Instance):
    def __init__(self, engine, tasks_from_failed):
        &#34;&#34;&#34;
        Objects of this class represent clients. 
        `engine` - an instance of either AbstractEngine&#39;s subclass or LocalEngine.
        `tasks_from_failed` - the list to which the tasks assigned to this client are to be appended should this client fail.
        &#34;&#34;&#34;
        super().__init__(InstanceRole.CLIENT, engine)
        self.tasks_from_failed = tasks_from_failed
        self.my_tasks = [] # ids of tasks held by the client

        # The following is for backup server - ids of client messages forwarded by primary server not yet matched by direct messages from the client
        self.received_ids = []
    
    def __del__(self):
        if self.active_timestamp:
            self.events_file.close()
            self.exceptions_file.close()
        self.tasks_from_failed += self.my_tasks
        super().__del__()
    
    def connect(self, server_role: str):
        &#34;&#34;&#34;
        Connect to the appropriate queues
        &#34;&#34;&#34;
        self.inbound_q, self.outbound_q = None, None
        try:
            if server_role == InstanceRole.PRIMARY_SERVER:
                self.inbound_q, self.outbound_q = \
                    util.get_guest_qs(
                        self.ip, self.port_primary, 
                        [&#39;outbound&#39;, &#39;inbound&#39;])
            else:
                assert(server_role == InstanceRole.BACKUP_SERVER)
                self.inbound_q, self.outbound_q = \
                    util.get_guest_qs(
                        self.ip, self.port_backup, 
                        [&#39;outbound&#39;, &#39;inbound&#39;])
        except:
            pass # if the client has died, it will be handled elsewhere

    def init_files(self, parent_dir):
        path = os.path.join(parent_dir, self.name)
        os.makedirs(path, exist_ok=True)
        self.events_file = open(os.path.join(path, &#39;events.txt&#39;), &#34;a&#34;)
        self.exceptions_file = open(os.path.join(path, &#39;exceptions.txt&#39;), &#34;a&#34;)
        
    def shake_hands(self, server_role, parent_dir: str):
        myprint(Verbosity.instance_creation_etc, 
                f&#34;{server_role} attempting to connect to client queues&#34;)
        self.connect(server_role)
        myprint(Verbosity.instance_creation_etc,
                f&#34;{server_role} connected to client queues&#34;)
        self.init_files(parent_dir)
        super().shake_hands()

    def register_tasks(self, tasks):
        self.my_tasks += [t.id for t in tasks]
        for t in tasks:
            myprint(Verbosity.all, f&#34;Task {t.id} is at {self.name}&#34;)
    
    def unregister_task(self, t_id):
        self.my_tasks = list(filter(lambda i: i != t_id, self.my_tasks))

    def unregister_domino(self, tasks, hardness):
        hard = [t_id for t_id in self.my_tasks 
                if tasks[t_id].hardness &gt;= hardness]
        self.my_tasks = list(filter(lambda i: i not in hard, self.my_tasks))

class BackupServerInstance(Instance):
    &#34;&#34;&#34;
    Objects of this class represent backup servers. 
    &#34;&#34;&#34;
    def __init__(self, engine):
        &#34;&#34;&#34;
        `engine` - an instance of either AbstractEngine&#39;s subclass or LocalEngine.
        &#34;&#34;&#34;
        super().__init__(InstanceRole.BACKUP_SERVER, engine)

    def shake_hands(self):
        self.inbound_q, self.outbound_q = \
            util.get_guest_qs(
                self.ip, self.port, [&#39;to_primary_q&#39;, &#39;from_primary_q&#39;])
        super().shake_hands()

class PrimaryServerInstance:
    &#34;&#34;&#34;
    In backup server, an object of this class represents the primary server. Note that this class does not inherit from `Instance`.
    &#34;&#34;&#34;
    def __init__(self, my_port):
        self.role = InstanceRole.PRIMARY_SERVER
        self.ip = util.command_arg_ip()
        self.name = &#39;primary-server&#39;
        self.manager = util.make_manager(
            [&#39;to_primary_q&#39;, &#39;from_primary_q&#39;], my_port)
        self.outbound_q, self.inbound_q = \
            self.manager.to_primary_q(), self.manager.from_primary_q()
        self.active_timestamp = time.time()
    
    def is_healthy(self):
        return time.time() - self.active_timestamp &lt;= \
               Constants.HEALTH_UPDATE_LIMIT</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="ExpoCloud.src.instance.is_backup"><code class="name flex">
<span>def <span class="ident">is_backup</span></span>(<span>instance)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_backup(instance):
    return instance.role == InstanceRole.BACKUP_SERVER</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.is_client"><code class="name flex">
<span>def <span class="ident">is_client</span></span>(<span>instance)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_client(instance):
    return instance.role == InstanceRole.CLIENT</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.is_primary"><code class="name flex">
<span>def <span class="ident">is_primary</span></span>(<span>instance)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_primary(instance):
    return instance.role == InstanceRole.PRIMARY_SERVER</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="ExpoCloud.src.instance.BackupServerInstance"><code class="flex name class">
<span>class <span class="ident">BackupServerInstance</span></span>
<span>(</span><span>engine)</span>
</code></dt>
<dd>
<div class="desc"><p>Objects of this class represent backup servers. </p>
<p><code>engine</code> - an instance of either AbstractEngine's subclass or LocalEngine.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class BackupServerInstance(Instance):
    &#34;&#34;&#34;
    Objects of this class represent backup servers. 
    &#34;&#34;&#34;
    def __init__(self, engine):
        &#34;&#34;&#34;
        `engine` - an instance of either AbstractEngine&#39;s subclass or LocalEngine.
        &#34;&#34;&#34;
        super().__init__(InstanceRole.BACKUP_SERVER, engine)

    def shake_hands(self):
        self.inbound_q, self.outbound_q = \
            util.get_guest_qs(
                self.ip, self.port, [&#39;to_primary_q&#39;, &#39;from_primary_q&#39;])
        super().shake_hands()</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="ExpoCloud.src.instance.Instance" href="#ExpoCloud.src.instance.Instance">Instance</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="ExpoCloud.src.instance.BackupServerInstance.shake_hands"><code class="name flex">
<span>def <span class="ident">shake_hands</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def shake_hands(self):
    self.inbound_q, self.outbound_q = \
        util.get_guest_qs(
            self.ip, self.port, [&#39;to_primary_q&#39;, &#39;from_primary_q&#39;])
    super().shake_hands()</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="ExpoCloud.src.instance.Instance" href="#ExpoCloud.src.instance.Instance">Instance</a></b></code>:
<ul class="hlist">
<li><code><a title="ExpoCloud.src.instance.Instance.create" href="#ExpoCloud.src.instance.Instance.create">create</a></code></li>
<li><code><a title="ExpoCloud.src.instance.Instance.is_healthy" href="#ExpoCloud.src.instance.Instance.is_healthy">is_healthy</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="ExpoCloud.src.instance.ClientInstance"><code class="flex name class">
<span>class <span class="ident">ClientInstance</span></span>
<span>(</span><span>engine, tasks_from_failed)</span>
</code></dt>
<dd>
<div class="desc"><p>Objects of this class represent clients.
<code>engine</code> - an instance of either AbstractEngine's subclass or LocalEngine.
<code>tasks_from_failed</code> - the list to which the tasks assigned to this client are to be appended should this client fail.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ClientInstance(Instance):
    def __init__(self, engine, tasks_from_failed):
        &#34;&#34;&#34;
        Objects of this class represent clients. 
        `engine` - an instance of either AbstractEngine&#39;s subclass or LocalEngine.
        `tasks_from_failed` - the list to which the tasks assigned to this client are to be appended should this client fail.
        &#34;&#34;&#34;
        super().__init__(InstanceRole.CLIENT, engine)
        self.tasks_from_failed = tasks_from_failed
        self.my_tasks = [] # ids of tasks held by the client

        # The following is for backup server - ids of client messages forwarded by primary server not yet matched by direct messages from the client
        self.received_ids = []
    
    def __del__(self):
        if self.active_timestamp:
            self.events_file.close()
            self.exceptions_file.close()
        self.tasks_from_failed += self.my_tasks
        super().__del__()
    
    def connect(self, server_role: str):
        &#34;&#34;&#34;
        Connect to the appropriate queues
        &#34;&#34;&#34;
        self.inbound_q, self.outbound_q = None, None
        try:
            if server_role == InstanceRole.PRIMARY_SERVER:
                self.inbound_q, self.outbound_q = \
                    util.get_guest_qs(
                        self.ip, self.port_primary, 
                        [&#39;outbound&#39;, &#39;inbound&#39;])
            else:
                assert(server_role == InstanceRole.BACKUP_SERVER)
                self.inbound_q, self.outbound_q = \
                    util.get_guest_qs(
                        self.ip, self.port_backup, 
                        [&#39;outbound&#39;, &#39;inbound&#39;])
        except:
            pass # if the client has died, it will be handled elsewhere

    def init_files(self, parent_dir):
        path = os.path.join(parent_dir, self.name)
        os.makedirs(path, exist_ok=True)
        self.events_file = open(os.path.join(path, &#39;events.txt&#39;), &#34;a&#34;)
        self.exceptions_file = open(os.path.join(path, &#39;exceptions.txt&#39;), &#34;a&#34;)
        
    def shake_hands(self, server_role, parent_dir: str):
        myprint(Verbosity.instance_creation_etc, 
                f&#34;{server_role} attempting to connect to client queues&#34;)
        self.connect(server_role)
        myprint(Verbosity.instance_creation_etc,
                f&#34;{server_role} connected to client queues&#34;)
        self.init_files(parent_dir)
        super().shake_hands()

    def register_tasks(self, tasks):
        self.my_tasks += [t.id for t in tasks]
        for t in tasks:
            myprint(Verbosity.all, f&#34;Task {t.id} is at {self.name}&#34;)
    
    def unregister_task(self, t_id):
        self.my_tasks = list(filter(lambda i: i != t_id, self.my_tasks))

    def unregister_domino(self, tasks, hardness):
        hard = [t_id for t_id in self.my_tasks 
                if tasks[t_id].hardness &gt;= hardness]
        self.my_tasks = list(filter(lambda i: i not in hard, self.my_tasks))</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="ExpoCloud.src.instance.Instance" href="#ExpoCloud.src.instance.Instance">Instance</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="ExpoCloud.src.instance.ClientInstance.connect"><code class="name flex">
<span>def <span class="ident">connect</span></span>(<span>self, server_role: str)</span>
</code></dt>
<dd>
<div class="desc"><p>Connect to the appropriate queues</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def connect(self, server_role: str):
    &#34;&#34;&#34;
    Connect to the appropriate queues
    &#34;&#34;&#34;
    self.inbound_q, self.outbound_q = None, None
    try:
        if server_role == InstanceRole.PRIMARY_SERVER:
            self.inbound_q, self.outbound_q = \
                util.get_guest_qs(
                    self.ip, self.port_primary, 
                    [&#39;outbound&#39;, &#39;inbound&#39;])
        else:
            assert(server_role == InstanceRole.BACKUP_SERVER)
            self.inbound_q, self.outbound_q = \
                util.get_guest_qs(
                    self.ip, self.port_backup, 
                    [&#39;outbound&#39;, &#39;inbound&#39;])
    except:
        pass # if the client has died, it will be handled elsewhere</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.ClientInstance.init_files"><code class="name flex">
<span>def <span class="ident">init_files</span></span>(<span>self, parent_dir)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def init_files(self, parent_dir):
    path = os.path.join(parent_dir, self.name)
    os.makedirs(path, exist_ok=True)
    self.events_file = open(os.path.join(path, &#39;events.txt&#39;), &#34;a&#34;)
    self.exceptions_file = open(os.path.join(path, &#39;exceptions.txt&#39;), &#34;a&#34;)</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.ClientInstance.register_tasks"><code class="name flex">
<span>def <span class="ident">register_tasks</span></span>(<span>self, tasks)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def register_tasks(self, tasks):
    self.my_tasks += [t.id for t in tasks]
    for t in tasks:
        myprint(Verbosity.all, f&#34;Task {t.id} is at {self.name}&#34;)</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.ClientInstance.shake_hands"><code class="name flex">
<span>def <span class="ident">shake_hands</span></span>(<span>self, server_role, parent_dir: str)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def shake_hands(self, server_role, parent_dir: str):
    myprint(Verbosity.instance_creation_etc, 
            f&#34;{server_role} attempting to connect to client queues&#34;)
    self.connect(server_role)
    myprint(Verbosity.instance_creation_etc,
            f&#34;{server_role} connected to client queues&#34;)
    self.init_files(parent_dir)
    super().shake_hands()</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.ClientInstance.unregister_domino"><code class="name flex">
<span>def <span class="ident">unregister_domino</span></span>(<span>self, tasks, hardness)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def unregister_domino(self, tasks, hardness):
    hard = [t_id for t_id in self.my_tasks 
            if tasks[t_id].hardness &gt;= hardness]
    self.my_tasks = list(filter(lambda i: i not in hard, self.my_tasks))</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.ClientInstance.unregister_task"><code class="name flex">
<span>def <span class="ident">unregister_task</span></span>(<span>self, t_id)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def unregister_task(self, t_id):
    self.my_tasks = list(filter(lambda i: i != t_id, self.my_tasks))</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="ExpoCloud.src.instance.Instance" href="#ExpoCloud.src.instance.Instance">Instance</a></b></code>:
<ul class="hlist">
<li><code><a title="ExpoCloud.src.instance.Instance.create" href="#ExpoCloud.src.instance.Instance.create">create</a></code></li>
<li><code><a title="ExpoCloud.src.instance.Instance.is_healthy" href="#ExpoCloud.src.instance.Instance.is_healthy">is_healthy</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="ExpoCloud.src.instance.Instance"><code class="flex name class">
<span>class <span class="ident">Instance</span></span>
<span>(</span><span>role, engine)</span>
</code></dt>
<dd>
<div class="desc"><p>Objects of this class represent instances.
<code>role</code> - either InstanceRole.CLIENT or InstanceRole.BACKUP_SERVER.
<code>engine</code> - an instance of either AbstractEngine's subclass or LocalEngine.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class Instance():
    def __init__(self, role, engine):
        &#34;&#34;&#34;
        Objects of this class represent instances.
        `role` - either InstanceRole.CLIENT or InstanceRole.BACKUP_SERVER.
        `engine` - an instance of either AbstractEngine&#39;s subclass or LocalEngine.
        &#34;&#34;&#34;
        self.role = role
        self.engine = engine
        self.active_timestamp = None # last health update, None until handshake
        self.name = None
        if engine:
            self.name = engine.next_instance_name(role)
        self.ip = None
    
    def create(self):
        &#34;&#34;&#34;
        Create the instance
        &#34;&#34;&#34;
        self.ip = self.engine.create_instance(self.name, self.role)
        if self.ip: self.creation_timestamp = time.time()

    def run(self, server_port, max_cpus = None):
        self.engine.run_instance(self.name, self.ip, self.role, server_port, max_cpus)
    
    def __del__(self):
        if self.ip and self.engine:
            if not self.engine.is_local(): # for local, just let it complete
                self.engine.kill_instance(self.name)
    
    def is_healthy(self, tasks_remain: bool):
        &#34;&#34;&#34;
        `task remain` - a Boolean indicating whether there are still tasks remaining.
        Returns true if the instance is healthy, i.e. either:
        - The instance has no IP address (so that no real instance had been created) and there are task remaining.
        - The instance has an IP address, but is not active (i.e. has not shaken hands with the primary server). For client instance, we also require that there still be tasks remaining as indicated. For all types of instances, INSTANCE_MAX_NON_ACTIVE_TIME has not passed since its creation.
        - It is active and HEALTH_UPDATE_LIMIT has not passed since last health 
          update.
        &#34;&#34;&#34;
        if self.active_timestamp:
            result = \
                time.time() - self.active_timestamp &lt;= \
                Constants.HEALTH_UPDATE_LIMIT
            if not result: 
                myprint(Verbosity.all, 
                        f&#34;{self.name} failed to send health updates for too long.   Last update: {util.short_timestamp(self.active_timestamp)}&#34;)
            return result
        
        assert(not self.active_timestamp)

        if self.ip and \
           time.time() - self.creation_timestamp &gt; \
           Constants.INSTANCE_MAX_NON_ACTIVE_TIME:
            myprint(Verbosity.all, f&#34;{self.name} failed to shake hands for too long.   Creation: {util.short_timestamp(self.creation_timestamp)}&#34;) 
            return False
        
        if is_backup(self): return True
        if is_client(self):
            result = tasks_remain
            if not result:
                myprint(Verbosity.all, f&#34;{self.name} is unneeded&#34;)
            return result

        assert(False)

    def shake_hands(self):
        myprint(Verbosity.all, f&#34;{self.name} shook hands&#34;)
        self.active_timestamp = time.time()</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="ExpoCloud.src.instance.BackupServerInstance" href="#ExpoCloud.src.instance.BackupServerInstance">BackupServerInstance</a></li>
<li><a title="ExpoCloud.src.instance.ClientInstance" href="#ExpoCloud.src.instance.ClientInstance">ClientInstance</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="ExpoCloud.src.instance.Instance.create"><code class="name flex">
<span>def <span class="ident">create</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"><p>Create the instance</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def create(self):
    &#34;&#34;&#34;
    Create the instance
    &#34;&#34;&#34;
    self.ip = self.engine.create_instance(self.name, self.role)
    if self.ip: self.creation_timestamp = time.time()</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.Instance.is_healthy"><code class="name flex">
<span>def <span class="ident">is_healthy</span></span>(<span>self, tasks_remain: bool)</span>
</code></dt>
<dd>
<div class="desc"><p><code>task remain</code> - a Boolean indicating whether there are still tasks remaining.
Returns true if the instance is healthy, i.e. either:
- The instance has no IP address (so that no real instance had been created) and there are task remaining.
- The instance has an IP address, but is not active (i.e. has not shaken hands with the primary server). For client instance, we also require that there still be tasks remaining as indicated. For all types of instances, INSTANCE_MAX_NON_ACTIVE_TIME has not passed since its creation.
- It is active and HEALTH_UPDATE_LIMIT has not passed since last health
update.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_healthy(self, tasks_remain: bool):
    &#34;&#34;&#34;
    `task remain` - a Boolean indicating whether there are still tasks remaining.
    Returns true if the instance is healthy, i.e. either:
    - The instance has no IP address (so that no real instance had been created) and there are task remaining.
    - The instance has an IP address, but is not active (i.e. has not shaken hands with the primary server). For client instance, we also require that there still be tasks remaining as indicated. For all types of instances, INSTANCE_MAX_NON_ACTIVE_TIME has not passed since its creation.
    - It is active and HEALTH_UPDATE_LIMIT has not passed since last health 
      update.
    &#34;&#34;&#34;
    if self.active_timestamp:
        result = \
            time.time() - self.active_timestamp &lt;= \
            Constants.HEALTH_UPDATE_LIMIT
        if not result: 
            myprint(Verbosity.all, 
                    f&#34;{self.name} failed to send health updates for too long.   Last update: {util.short_timestamp(self.active_timestamp)}&#34;)
        return result
    
    assert(not self.active_timestamp)

    if self.ip and \
       time.time() - self.creation_timestamp &gt; \
       Constants.INSTANCE_MAX_NON_ACTIVE_TIME:
        myprint(Verbosity.all, f&#34;{self.name} failed to shake hands for too long.   Creation: {util.short_timestamp(self.creation_timestamp)}&#34;) 
        return False
    
    if is_backup(self): return True
    if is_client(self):
        result = tasks_remain
        if not result:
            myprint(Verbosity.all, f&#34;{self.name} is unneeded&#34;)
        return result

    assert(False)</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.Instance.run"><code class="name flex">
<span>def <span class="ident">run</span></span>(<span>self, server_port, max_cpus=None)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def run(self, server_port, max_cpus = None):
    self.engine.run_instance(self.name, self.ip, self.role, server_port, max_cpus)</code></pre>
</details>
</dd>
<dt id="ExpoCloud.src.instance.Instance.shake_hands"><code class="name flex">
<span>def <span class="ident">shake_hands</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def shake_hands(self):
    myprint(Verbosity.all, f&#34;{self.name} shook hands&#34;)
    self.active_timestamp = time.time()</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="ExpoCloud.src.instance.PrimaryServerInstance"><code class="flex name class">
<span>class <span class="ident">PrimaryServerInstance</span></span>
<span>(</span><span>my_port)</span>
</code></dt>
<dd>
<div class="desc"><p>In backup server, an object of this class represents the primary server. Note that this class does not inherit from <code><a title="ExpoCloud.src.instance.Instance" href="#ExpoCloud.src.instance.Instance">Instance</a></code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class PrimaryServerInstance:
    &#34;&#34;&#34;
    In backup server, an object of this class represents the primary server. Note that this class does not inherit from `Instance`.
    &#34;&#34;&#34;
    def __init__(self, my_port):
        self.role = InstanceRole.PRIMARY_SERVER
        self.ip = util.command_arg_ip()
        self.name = &#39;primary-server&#39;
        self.manager = util.make_manager(
            [&#39;to_primary_q&#39;, &#39;from_primary_q&#39;], my_port)
        self.outbound_q, self.inbound_q = \
            self.manager.to_primary_q(), self.manager.from_primary_q()
        self.active_timestamp = time.time()
    
    def is_healthy(self):
        return time.time() - self.active_timestamp &lt;= \
               Constants.HEALTH_UPDATE_LIMIT</code></pre>
</details>
<h3>Methods</h3>
<dl>
<dt id="ExpoCloud.src.instance.PrimaryServerInstance.is_healthy"><code class="name flex">
<span>def <span class="ident">is_healthy</span></span>(<span>self)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def is_healthy(self):
    return time.time() - self.active_timestamp &lt;= \
           Constants.HEALTH_UPDATE_LIMIT</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="ExpoCloud.src" href="index.html">ExpoCloud.src</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="ExpoCloud.src.instance.is_backup" href="#ExpoCloud.src.instance.is_backup">is_backup</a></code></li>
<li><code><a title="ExpoCloud.src.instance.is_client" href="#ExpoCloud.src.instance.is_client">is_client</a></code></li>
<li><code><a title="ExpoCloud.src.instance.is_primary" href="#ExpoCloud.src.instance.is_primary">is_primary</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="ExpoCloud.src.instance.BackupServerInstance" href="#ExpoCloud.src.instance.BackupServerInstance">BackupServerInstance</a></code></h4>
<ul class="">
<li><code><a title="ExpoCloud.src.instance.BackupServerInstance.shake_hands" href="#ExpoCloud.src.instance.BackupServerInstance.shake_hands">shake_hands</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="ExpoCloud.src.instance.ClientInstance" href="#ExpoCloud.src.instance.ClientInstance">ClientInstance</a></code></h4>
<ul class="two-column">
<li><code><a title="ExpoCloud.src.instance.ClientInstance.connect" href="#ExpoCloud.src.instance.ClientInstance.connect">connect</a></code></li>
<li><code><a title="ExpoCloud.src.instance.ClientInstance.init_files" href="#ExpoCloud.src.instance.ClientInstance.init_files">init_files</a></code></li>
<li><code><a title="ExpoCloud.src.instance.ClientInstance.register_tasks" href="#ExpoCloud.src.instance.ClientInstance.register_tasks">register_tasks</a></code></li>
<li><code><a title="ExpoCloud.src.instance.ClientInstance.shake_hands" href="#ExpoCloud.src.instance.ClientInstance.shake_hands">shake_hands</a></code></li>
<li><code><a title="ExpoCloud.src.instance.ClientInstance.unregister_domino" href="#ExpoCloud.src.instance.ClientInstance.unregister_domino">unregister_domino</a></code></li>
<li><code><a title="ExpoCloud.src.instance.ClientInstance.unregister_task" href="#ExpoCloud.src.instance.ClientInstance.unregister_task">unregister_task</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="ExpoCloud.src.instance.Instance" href="#ExpoCloud.src.instance.Instance">Instance</a></code></h4>
<ul class="">
<li><code><a title="ExpoCloud.src.instance.Instance.create" href="#ExpoCloud.src.instance.Instance.create">create</a></code></li>
<li><code><a title="ExpoCloud.src.instance.Instance.is_healthy" href="#ExpoCloud.src.instance.Instance.is_healthy">is_healthy</a></code></li>
<li><code><a title="ExpoCloud.src.instance.Instance.run" href="#ExpoCloud.src.instance.Instance.run">run</a></code></li>
<li><code><a title="ExpoCloud.src.instance.Instance.shake_hands" href="#ExpoCloud.src.instance.Instance.shake_hands">shake_hands</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="ExpoCloud.src.instance.PrimaryServerInstance" href="#ExpoCloud.src.instance.PrimaryServerInstance">PrimaryServerInstance</a></code></h4>
<ul class="">
<li><code><a title="ExpoCloud.src.instance.PrimaryServerInstance.is_healthy" href="#ExpoCloud.src.instance.PrimaryServerInstance.is_healthy">is_healthy</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>